# é…ç½®åŒ–å®ç°

## åˆå¹¶é…ç½®çš„è®¾è®¡ä¸å®ç°

### éœ€æ±‚åˆ†æ

åœ¨å‘é€è¯·æ±‚çš„æ—¶å€™å¯ä»¥ä¼ å…¥ä¸€ä¸ªé…ç½®æ¥å†³å®šè¯·æ±‚çš„ä¸åŒè¡Œä¸ºã€‚æ‰€ä»¥ç»™`axios`æ¥ä¸ªé»˜è®¤é…ç½®ï¼Œå®šä¹‰ä¸€äº›é»˜è®¤çš„è¡Œä¸ºã€‚è¿™æ ·å‘é€æ¯ä¸ªè¯·æ±‚ï¼Œç”¨æˆ·ä¼ é€’çš„é…ç½®å¯ä»¥å’Œé»˜è®¤é…ç½®åšä¸€å±‚çš„åˆå¹¶ã€‚

å’Œå®˜ç½‘ `axios` åº“ä¿æŒä¸€è‡´ï¼Œæˆ‘ä»¬ç»™ `axios` å¯¹è±¡æ·»åŠ ä¸€ä¸ª `defaults` å±æ€§ï¼Œè¡¨ç¤ºé»˜è®¤é…ç½®ï¼Œä½ ç”šè‡³å¯ä»¥ç›´æ¥ä¿®æ”¹è¿™äº›é»˜è®¤é…ç½®ï¼š

```typescript
axios.defaults.headers.common['test'] = 123
axios.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded'
axios.defaults.timeout = 2000
```

å…¶ä¸­å¯¹äº `headers` çš„é»˜è®¤é…ç½®æ”¯æŒ `common` å’Œä¸€äº›è¯·æ±‚ `method` å­—æ®µã€‚

`common` è¡¨ç¤ºå¯¹äºä»»ä½•ç±»å‹çš„è¯·æ±‚éƒ½è¦æ·»åŠ è¯¥å±æ€§

`method` è¡¨ç¤ºåªæœ‰è¯¥ç±»å‹è¯·æ±‚æ–¹æ³•æ‰ä¼šæ·»åŠ å¯¹åº”çš„å±æ€§ã€‚

åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¼šé»˜è®¤ä¸ºæ‰€æœ‰è¯·æ±‚çš„ `header` æ·»åŠ  `test` å±æ€§ï¼Œä¼šé»˜è®¤ä¸º `post` è¯·æ±‚çš„ `header` æ·»åŠ  `Content-Type` å±æ€§ã€‚



### é»˜è®¤é…ç½®å®šä¹‰

åœ¨srcä¸‹åˆ›å»ºdefaults.tsæ–‡ä»¶ï¼Œæ¥å¡«å†™é»˜è®¤çš„é…ç½®ã€‚

`src/defaults.ts`:

```typescript
import {AxiosRequestConfig} from './types'

const defaults:AxiosReqestConfig = {
    method:'get',
    timeout:0,
    headers:{
        common:{
            Accept:'application/json,text/plain,*/*',
        }
    }
}

const methodsNoData = ['delete','get','head','options'];
// åˆå§‹åŒ–
methodsNoData.forEach(method=>{
    defaults.headers[method]={};
})

const methodsWithData = ['post','put','patch'];
// åˆå§‹åŒ–
methodsWithData.forEach(method=>{
    defaults.headers[method]={
        'Content-Type': 'application/x-www-form-urlencoded'
    };
});
export default defaults;
```

è¿™é‡Œå®šä¹‰äº†`defaults`å¸¸é‡ï¼Œå®ƒåŒ…å«äº†é»˜è®¤è¯·æ±‚çš„æ–¹æ³•ã€è¶…æ—¶æ—¶é—´ä»¥åŠ`headers`ä¸€äº›é…ç½®ã€‚

æœªæ¥æˆ‘ä»¬ä¼šæ ¹æ®æ–°çš„éœ€æ±‚æ·»åŠ æ›´å¤šçš„é»˜è®¤é…ç½®ã€‚



### æ·»åŠ åˆ°axioså¯¹è±¡ä¸­

æ ¹æ®éœ€æ±‚ï¼Œæˆ‘ä»¬è¦ç»™`axios`å¯¹è±¡æ·»åŠ ä¸€ä¸ª`defaults`å±æ€§ï¼Œè¡¨ç¤ºé»˜è®¤é…ç½®ï¼š

`src/core/Axios.ts`:

```typescript
import {
    AxiosPromise,
    AxiosRequestConfig,
    AxiosResponse,
    ResolvedFn,
    RejectedFn
} from '../types';

import dispatchRequest from './dispatchRequest';
import InterceptorManage from './InterceptorManage';

interface Interceptors{
    request:InterceptorManager<AxiosRequestConfig>;
    response:InterceptorManager<AxiosResponse>;
}
interface PromiseChain{
    resolved:ResolvedFn | ((config:AxiosRequestConfig)=>AxiosPromise) //å…¼å®¹åˆ°dispatchRequest
    rejected:RejectedFn;
}
export default class Axios{
    defaults:AxiosRequestConfig;
    interceptors:Interceptors;
    // å®ä¾‹åŒ–çš„æ—¶å€™ä¼ å…¥é»˜è®¤å€¼
    constructor(initConfig:AxiosRequestConfig){
        this.defaults = initConfig;
        this.interceptors={
            request: new InterceptorManager<AxiosRequestConfig>(),
      		response: new InterceptorManager<AxiosResponse>()
        }
    }
    ...
}
```

  ç»™`Axios`ç±»æ·»åŠ ä¸€ä¸ª`defaults`æˆå‘˜å±æ€§ï¼Œå¹¶ä¸”è®©`Axios`çš„æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ª`initConfig`å¯¹è±¡ï¼ŒæŠŠ`initConfig`èµ‹å€¼ç»™`this.defaults`ã€‚

å› ä¸º`Axios`ç±»ä¸­æ–°å¢äº†`defaults`å±æ€§ï¼Œæ‰€ä»¥`Axios`ç±»å‹å®šä¹‰ä¸­ä¹Ÿéœ€è¦åŠ å…¥`defaults`å®šä¹‰ã€‚

`src/types/index.ts`:

```typescript
...
export interface Axios{
    defaults:AxiosRequestConfig;
    interceptors:{
        ...
    };
    ...
}
...
```

æ¥ç€ä¿®æ”¹`createInstance`æ–¹æ³•ï¼Œæ”¯æŒä¼ å…¥`config`å¯¹è±¡ï¼š

`src/axios.ts`:

```typescript
import {AxiosInstance,AxiosRequestConfig} form '../types'
import Axios from './core/Axios';
import { extend } from './helpers/util';
import defaults from './defaults'
// ä¼ å…¥é»˜è®¤çš„defaultsé…ç½®
function createInstance(config:AxiosRequestConfig):AxiosInstance{
    const context = new Axios(config);
 
    const instance = Axios.prototype.request.bind(context);

    extend(instance,context);

    return instance as AxiosInstance
}
// ä¼ å…¥é»˜è®¤çš„defaultsé…ç½®
const axios = createInstance(defaults);

export default axios;
```

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨æ‰§è¡Œ`createInstance`åˆ›å»º`axios`å¯¹è±¡çš„æ—¶å€™æŠŠé»˜è®¤é…ç½®ä¼ å…¥äº†ã€‚



### é…ç½®åˆå¹¶åŠç­–ç•¥

å®šä¹‰äº†é»˜è®¤é…ç½®åï¼Œæˆ‘ä»¬å‘é€æ¯ä¸ªè¯·æ±‚çš„æ—¶å€™éœ€è¦æŠŠè‡ªå®šä¹‰é…ç½®å’Œé»˜è®¤é…ç½®åšåˆå¹¶ï¼Œå®ƒå¹¶ä¸æ˜¯ç®€å•çš„ä¸¤ä¸ªæ™®é€šå¯¹è±¡çš„åˆå¹¶ï¼Œå¯¹äºä¸åŒçš„å­—æ®µåˆå¹¶ä¼šæœ‰ä¸åŒçš„åˆå¹¶ç­–ç•¥ã€‚ä¸¾ä¸ªğŸŒ°ï¼š

```js
// é»˜è®¤é…ç½®
config1 = {
  method: 'get',

  timeout: 0,

  headers: {
    common: {
      Accept: 'application/json, text/plain, */*'
    }
  }
}

// ç”¨æˆ·å®šä¹‰é…ç½®
config2 = {
  url: '/config/post',
  method: 'post',
  data: {
    a: 1
  },
  headers: {
    test: '321'
  }
}

// åˆå¹¶åçš„é…ç½®
merged = {
  url: '/config/post',
  method: 'post',
  data: {
    a: 1
  },
  timeout: 0,
  headers: {
    common: {
      Accept: 'application/json, text/plain, */*'
    }
    test: '321'
  }
}
```



æˆ‘ä»¬åœ¨`src/core`åˆ›å»º`mergeConfig.ts`æ–‡ä»¶æ¥å®ç°åˆå¹¶æ–¹æ³•ã€‚

`src/core/mergeConfing.ts`:

```typescript
import {AxiosRequestConfig} from '../types'
import {deepMerge,isPlainObject} from '../helpers/util';

// åˆå¹¶ç­–ç•¥çš„map
const strats = Object.create(null);

// é»˜è®¤åˆå¹¶ç­–ç•¥ (ç­–ç•¥æ¨¡å¼)
function defaultStrat(val1:any,val2:any):any{
    return typeof val2 !== 'undefined' ? val2 :val1;
}

// æ¥å—è‡ªå®šä¹‰é…ç½®åˆå¹¶ç­–ç•¥
function fromVal2Strat(val1:any,val2:any):any{
    if(typeof val2 !== 'undefind'){
        return val2;
    }
}

// headerså¤æ‚å¯¹è±¡åˆå¹¶é…ç½®ç­–ç•¥
function deepMergeStrat(val1:any,val2:any):any{
    if(isPlainObject(val2)){
        return deepMerge(val1,val2)
    }else if(typeof val2 !== 'undefined'){
        return val2;
    }else if(isPlainObject(val1)){
        return deepMerge(val1)
    }else if(typeof val1 !== 'undefined'){
        return val1;
    }
}

// ä¸€èˆ¬åƒæ˜¯urlï¼Œparams,dataéƒ½æ˜¯ç”¨æˆ·è‡ªå·±ä¼ å…¥çš„ï¼Œæ‰€ä»¥ç›´æ¥è¦†ç›–å³å¯ï¼Œä¸éœ€è¦ç®¡val1çš„å€¼
const stratKeyFromVal2 = ['url','params','data'];

stratKeyFromVal2.forEach(key=>{
    strats[key] = fromVal2Strat
})

const stratKeysDeepMerge = ['headers'];

stratKeysDeepMerge.forEach(key=>{
    strats[key] = deepMergeStrat
})

export default function mergeConfig(
	config1:AxiosRequestConfig,
    config2:AxiosRequestConfig,
):AxiosRequestConfig{
    if(!config2){
        config2={}
    }
    // Object.create(null) åˆ›å»ºå‡ºæ¥çš„å¯¹è±¡æ²¡æœ‰åŸå‹
    const config = Object.create(null)
    
    for(let key in config2){
        mergeField(key)
    }
    for(let key in config1){
        if(!config2[key]){
            mergeField(key)
        }
    }
    // åˆå¹¶æ–¹æ³•
    function mergeField(key:string):void{
        // å¦‚æœåœ¨stratsè‡ªå®šä¹‰é…ç½®ä¸­å°±æ‹¿è‡ªå®šä¹‰çš„åˆå¹¶ç­–ç•¥ï¼Œå¦åˆ™å°±ç”¨é»˜è®¤çš„ç­–ç•¥
        const strat = strats[key] || defaultStrat;
        config[key] = strat(config1[key],config2![key]);
    }
    return config;
}
```

åˆå¹¶æ–¹æ³•çš„æ•´ä½“æ€è·¯å°±æ˜¯å¯¹`config1`å’Œ`config2`ä¸­çš„å±æ€§éå†ï¼Œæ‰§è¡Œ`mergeField`æ–¹æ³•åšåˆå¹¶ï¼Œè¿™é‡Œ`config1`ä»£è¡¨é»˜è®¤é…ç½®ï¼Œ`config2`ä»£è¡¨è‡ªå®šä¹‰é…ç½®ã€‚

éå†è¿‡ç¨‹ä¸­,æˆ‘ä»¬ä¼šé€šè¿‡`config2[key]`è¿™ç§ç´¢å¼•çš„æ–¹å¼è®¿é—®å¯¹è±¡ï¼Œæ‰€ä»¥è¦ç»™`AxiosRequestCofnig`çš„æ¥å£æ·»åŠ ä¸€ä¸ªå­—ç¬¦ä¸²ç´¢å¼•ç­¾åï¼š

`src/types`:

```typescript
export interface AxiosRequestConfig {
  // ...

  [propName: string]: any
}
```

åœ¨`mergeField`æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¼šé’ˆå¯¹ä¸åŒçš„å±æ€§ä½¿ç”¨ä¸åŒçš„åˆå¹¶ç­–ç•¥ã€‚åˆ†ä¸ºé»˜è®¤åˆå¹¶ç­–ç•¥ï¼Œè‡ªå®šä¹‰é…ç½®åˆå¹¶ç­–ç•¥å’Œheaderså¤æ‚å¯¹è±¡åˆå¹¶ç­–ç•¥

é»˜è®¤åˆå¹¶ç­–ç•¥ï¼š`defaultStrat`å‡½æ•°å¾ˆç®€å•ï¼Œå¦‚æœæœ‰`val2`åˆ™è¿”å›`val2`ï¼Œå¦åˆ™è¿”å›`val1`ï¼Œä¹Ÿå°±æ˜¯å¦‚æœè‡ªå®šä¹‰é…ç½®ä¸­å®šä¹‰äº†æŸä¸ªå±æ€§ï¼Œå°±é‡‡ç”¨è‡ªå®šä¹‰çš„ï¼Œå¦åˆ™å°±ç”¨é»˜è®¤é…ç½®ã€‚

è‡ªå®šä¹‰é…ç½®åˆå¹¶ç­–ç•¥ï¼š`fromVal2Strat`å› ä¸ºå¯¹äº `url`ã€`params`ã€`data` è¿™äº›å±æ€§ï¼Œé»˜è®¤é…ç½®æ˜¾ç„¶æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå®ƒä»¬æ˜¯å’Œæ¯ä¸ªè¯·æ±‚å¼ºç›¸å…³çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªä»è‡ªå®šä¹‰é…ç½®ä¸­è·å–ã€‚

å¤æ‚å¯¹è±¡åˆå¹¶ç­–ç•¥ï¼šå¯¹äº `headers` è¿™ç±»çš„å¤æ‚å¯¹è±¡å±æ€§ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æ·±æ‹·è´çš„æ–¹å¼ï¼ŒåŒæ—¶ä¹Ÿå¤„ç†äº†å…¶å®ƒä¸€äº›æƒ…å†µï¼Œå› ä¸ºå®ƒä»¬ä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªéå¯¹è±¡çš„æ™®é€šå€¼ã€‚æœªæ¥æˆ‘ä»¬è®²åˆ°è®¤è¯æˆæƒçš„æ—¶å€™ï¼Œ`auth` å±æ€§ä¹Ÿæ˜¯è¿™ä¸ªåˆå¹¶ç­–ç•¥ã€‚

è¿™é‡Œæˆ‘ä»¬éœ€è¦åœ¨`src/helpers/util`ä¸­å®ç°æ·±æ‹·è´`deepMerge`å‡½æ•°

`src/helpers/util`:

```typescript
export function deepMerge(...objs:any[]):any{
    const result = Object.create(null);
    objs.forEach(obj=>{
        if(obj){
            Object.keys(obj).forEach(key=>{
                const val = obj[key];
                if(isPlainObject(val)){
                    if(isPlainObject(result[key])){
                        result[key] = deepMerge(result[key], val)
                    }else{
                       result[key] = deepMerge({}, val) 
                    }
                }else{
                    result[key] = val;
                }
            })
        }
    })
    return result;
}
```

æœ€åæˆ‘ä»¬åœ¨ `request` æ–¹æ³•é‡Œæ·»åŠ åˆå¹¶é…ç½®çš„é€»è¾‘ï¼š

`src/core/Axios.ts`:

```typescript
...
import mergeConfig from './mergeConfig';

export default class Axios{
	...
    request(url:any,config?:any):AxiosPromise{
        if(typeof url === 'string'){
            if(!config){
                config = {}
            }
            config.url = url;
        }else{
            config = url;
        }
        
        config = mergeConfig(this.defaults,config)
        
        // è°ƒç”¨é“¾
        const chain:PromiseChain[] = [{
            resolved:dispatchRequest,
            rejected:undefined,
        }];
        
        // å‘è°ƒç”¨é“¾å¤´éƒ¨æ·»åŠ requestæ‹¦æˆªå™¨æ–¹æ³•
        this.interceptors.request.forEach(interceptor=>{
            chain.unshift(interceptor)
        });
        
        // å‘è°ƒç”¨é“¾å°¾éƒ¨æ·»åŠ responseæ‹¦æˆªå™¨æ–¹æ³•
        this.interceptors.response.forEach(interceptor=>{
            chain.push(interceptor);
        });
        
        let promise = Promise.resolve(config);
        
        while (chain.length){
            const {resolved,rejected} = chain.shift()!; // è¿™é‡Œå› ä¸ºchainä¸­çš„rejectedæ˜¯undefinedæ‰€ä»¥ä¼šæŠ¥é”™ï¼Œä½¿ç”¨!ç±»å‹æ–­è¨€ä¸ä¸ºç©º
            promise = promise.then(resolved,rejected);
        }
        
        return promise;
    }
    ...
}
```



### flatten headers

ç»è¿‡åˆå¹¶åçš„é…ç½®ä¸­`headers`æ˜¯ä¸€ä¸ªå¤æ‚å¯¹è±¡ï¼Œå¤šäº†`common`ã€`post`ã€`get`ç­‰å±æ€§ï¼Œè€Œè¿™äº›å±æ€§ä¸­çš„å€¼æ‰æ˜¯æˆ‘ä»¬è¦çœŸæ­£æ·»åŠ åˆ°è¯·æ±‚`header`ä¸­çš„ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

```typescript
headers: {
  common: {
    Accept: 'application/json, text/plain, */*'
  },
  post: {
    'Content-Type':'application/x-www-form-urlencoded'
  }
}
```

æˆ‘ä»¬éœ€è¦æŠŠå®ƒå‹æˆä¸€çº§çš„ï¼Œå¦‚ä¸‹ï¼š

```typescript
headers: {
  Accept: 'application/json, text/plain, */*',
 'Content-Type':'application/x-www-form-urlencoded'
}
```

è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äº `common` ä¸­å®šä¹‰çš„ `header` å­—æ®µï¼Œæˆ‘ä»¬éƒ½è¦æå–ï¼Œè€Œå¯¹äº `post`ã€`get` è¿™ç±»æå–ï¼Œéœ€è¦å’Œè¯¥æ¬¡è¯·æ±‚çš„æ–¹æ³•å¯¹åº”ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å®ç° `flattenHeaders` æ–¹æ³•ã€‚

`src/helpers/header.ts`ï¼š

```typescript
export function flattenHeaders(headers:any,method:Mothod):any{
    if(!headers){
        return headers
    }
    headers = deepMerge(headers.comm || {},headers[method] || {},headers);
     const methodsToDelete = ['delete', 'get', 'head', 'options', 'post', 'put', 'patch', 'common']
     methodsToDelete.forEach(method => {
    	delete headers[method]
 	 })

  	return headers
}
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡ `deepMerge` çš„æ–¹å¼æŠŠ `common`ã€`post` çš„å±æ€§æ‹·è´åˆ° `headers` è¿™ä¸€çº§ï¼Œç„¶åå†æŠŠ `common`ã€`post` è¿™äº›å±æ€§åˆ æ‰ã€‚

ç„¶åæˆ‘ä»¬åœ¨çœŸæ­£å‘é€è¯·æ±‚å‰æ‰§è¡Œè¿™ä¸ªé€»è¾‘ã€‚

`src/core/dispatchRequest.ts`:

```typescript
function processConfig(config: AxiosRequestConfig): void {
  config.url = transformURL(config)
  // ç¬¬ä¸€éå¤„ç†headers
  config.headers = transformHeaders(config)
  config.data = transformRequestData(config)
   // ç¬¬äºŒéå¤„ç†headersåˆå¹¶é»˜è®¤é…ç½®
  config.headers = flattenHeaders(config.headers, config.method!)
}
```

è¿™æ ·ç¡®ä¿æˆ‘ä»¬äº†é…ç½®ä¸­çš„ `headers` æ˜¯å¯ä»¥æ­£ç¡®æ·»åŠ åˆ°è¯·æ±‚ `header` ä¸­çš„



### demoç¼–å†™

åœ¨ `examples` ç›®å½•ä¸‹åˆ›å»º `config` ç›®å½•ï¼Œåœ¨ `config` ç›®å½•ä¸‹åˆ›å»º `index.html`:

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Config example</title>
  </head>
  <body>
    <script src="/__build__/config.js"></script>
  </body>
</html>
```

æ¥ç€åˆ›å»º `app.ts` ä½œä¸ºå…¥å£æ–‡ä»¶ï¼š

```typescript
import axios from '../../src/index'
import qs from 'qs'

axios.defaults.headers.common['test2'] = 123

axios({
  url: '/config/post',
  method: 'post',
  data: qs.stringify({
    a: 1
  }),
  headers: {
    test: '321'
  }
}).then((res) => {
  console.log(res.data)
})
```

`examples/server.js`:

```js
...
const router = express.Router();

//registerInterceptorRouter();
registerConfigRouter();

app.use(router);

const port = process.env.PORT || 8080;
module.exports = app.listen(port, () => {
  console.log(`æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œè®¿é—®:http://localhost:${port}`)
})

function registerInterceptorRouter() {
    router.get('/interceptor/get',function(req,res){
        res.end('hello')
    })
}

function registerConfigRouter(){
    router.post('/config/post',function(req,res){
        res.json(req.body)
    })
}
...
```



è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬é¢å¤–å¼•å…¥äº† `qs` åº“ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŸ¥è¯¢å­—ç¬¦ä¸²è§£æå’Œå­—ç¬¦ä¸²åŒ–çš„åº“ã€‚

æ¯”å¦‚æˆ‘ä»¬çš„ä¾‹å­ä¸­å¯¹äº `{a:1}` ç»è¿‡ `qs.stringify` å˜æˆ `a=1`ã€‚

ç”±äºæˆ‘ä»¬çš„ä¾‹å­ç»™é»˜è®¤å€¼æ·»åŠ äº† `post` å’Œ `common` çš„ `headers`ï¼Œæˆ‘ä»¬åœ¨è¯·æ±‚å‰åšé…ç½®åˆå¹¶ï¼Œäºæ˜¯æˆ‘ä»¬è¯·æ±‚çš„ `header` å°±æ·»åŠ äº† `Content-Type` å­—æ®µï¼Œå®ƒçš„å€¼æ˜¯ `application/x-www-form-urlencoded`ï¼›å¦å¤–æˆ‘ä»¬ä¹Ÿæ·»åŠ äº† `test2` å­—æ®µï¼Œå®ƒçš„å€¼æ˜¯ `123`ã€‚

è‡³æ­¤ï¼Œæˆ‘ä»¬åˆå¹¶é…ç½®çš„é€»è¾‘å°±å®ç°å®Œäº†ã€‚æˆ‘ä»¬åœ¨å‰é¢çš„ç« èŠ‚ç¼–å†™ `axios` çš„åŸºç¡€åŠŸèƒ½çš„æ—¶å€™å¯¹è¯·æ±‚æ•°æ®å’Œå“åº”æ•°æ®éƒ½åšäº†å¤„ç†ï¼Œå®˜æ–¹ `axios` åˆ™æŠŠè¿™ä¿©éƒ¨åˆ†é€»è¾‘ä¹Ÿåšåˆ°äº†é»˜è®¤é…ç½®ä¸­ï¼Œæ„å‘³è¿™ç”¨æˆ·å¯ä»¥å»ä¿®æ”¹è¿™ä¿©éƒ¨åˆ†çš„é€»è¾‘ï¼Œå®ç°è‡ªå·±å¯¹è¯·æ±‚å’Œå“åº”æ•°æ®å¤„ç†çš„é€»è¾‘ã€‚é‚£ä¹ˆä¸‹ä¸€èŠ‚æˆ‘ä»¬å°±æ¥å®ç°è¿™ä¸ª featureã€‚



## è¯·æ±‚å’Œå“åº”é…ç½®åŒ–

### éœ€æ±‚åˆ†æ

å®˜æ–¹çš„`axios`åº“ç»™é»˜è®¤é…ç½®æ·»åŠ äº†`transformRequest`å’Œ`transformResponse`ä¸¤ä¸ªå­—æ®µï¼Œå®ƒä»¬çš„å€¼æ˜¯ä¸€ä¸ªæ•°ç»„æˆ–è€…æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚

å…¶ä¸­`transformRequest`å…è®¸ä½ åœ¨å°†è¯·æ±‚æ•°æ®å‘é€åˆ°æœåŠ¡å™¨ä¹‹å‰å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œè¿™åªé€‚ç”¨äºè¯·æ±‚æ–¹æ³•`put`ã€`post`å’Œ`patch`ï¼Œå¦‚æœå€¼æ˜¯æ•°ç»„ï¼Œåˆ™æ•°ç»„ä¸­çš„æœ€åä¸€ä¸ªå‡½æ•°å¿…é¡»è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²`FormData`ã€`URLSearchParams`ã€`Blob`ç­‰ç±»å‹ä½œä¸º`xhr.send`æ–¹æ³•çš„å‚æ•°ï¼Œè€Œä¸”åœ¨`transform`è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹`headers`å¯¹è±¡ã€‚

è€Œ `transformResponse` å…è®¸ä½ åœ¨æŠŠå“åº”æ•°æ®ä¼ é€’ç»™ `then` æˆ–è€… `catch` ä¹‹å‰å¯¹å®ƒä»¬è¿›è¡Œä¿®æ”¹ã€‚

å½“å€¼ä¸ºæ•°ç»„çš„æ—¶å€™ï¼Œæ•°ç»„çš„æ¯ä¸€ä¸ªå‡½æ•°éƒ½æ˜¯ä¸€ä¸ªè½¬æ¢å‡½æ•°ï¼Œæ•°ç»„ä¸­çš„å‡½æ•°å°±åƒç®¡é“ä¸€æ ·ä¾æ¬¡æ‰§è¡Œï¼Œå‰è€…çš„è¾“å‡ºä½œä¸ºåè€…çš„è¾“å…¥ã€‚

ğŸŒ°ï¼š

```js
axios({
    transformRequest:[
        (function(data){
        	return qs.stringify(data)
    	}),
        ...axios.defaults.transformRequest
    ],
    transformResponse:[
        axios.defaults.transformResponse,
        function(data){
            if(typeof data === 'object'){
                data.b=2
            }
            return data
        }
    ],
    url:'/config/post',
    method:'post',
    data:{
        a:1
    }
})
```



### ä¿®æ”¹é»˜è®¤é…ç½®

å…ˆè¦ä¿®æ”¹`AxiosRequestConfig`çš„ç±»å‹å®šä¹‰ï¼Œæ·»åŠ `transformRequest`å’Œ`transformResponse`ä¸¤ä¸ªå¯é€‰å±æ€§ã€‚

`src/types/index.js`:

```typescript
export interface AxiosRequestConfig{
    ...
    transformRequest?:AxiosTransformer | AxiosTransformer[]
    transfromResponse?:AxiosTransformer | AxiosTransformer[]
    
    [propName:string]:any
}
    
export interface AxiosTransformer{
    (data:any,headers?:any):any
}
```

æ¥ç€ä¿®æ”¹é»˜è®¤é…ç½®ï¼Œå¦‚ä¸‹ï¼š

`src/defaults.ts`ï¼š

```typescript
import { processHeaders } from './helpers/headers'
import { transformRequest, transformResponse } from './helpers/data'

const defaults:AxiosRequestConfig={
    method:'get',
    timeout:0,
    headers:{
        common:{
            Accept:'application/json,text/plain,*/*',
        }
    },
    transformRequest:[
        function(data:any,headers:any):any{
            processHeaders(headers,data);
            return transformRequest(data);
        }
    ],
    transformResponse:[
        function(data:any):any{
            return transformResponse(data)
        }
    ]
}
```

æˆ‘ä»¬æŠŠä¹‹å‰å¯¹è¯·æ±‚æ•°æ®å’Œå“åº”æ•°æ®çš„å¤„ç†é€»è¾‘ï¼Œæ”¾åˆ°é»˜è®¤é…ç½®ä¸­ï¼Œä¹Ÿå°±æ˜¯é»˜è®¤å¤„ç†é€»è¾‘ã€‚



### transformé€»è¾‘é‡æ„

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±è¦é‡æ„ä¹‹å‰å†™çš„è¯·æ±‚æ•°æ®å’Œå“åº”æ•°æ®çš„å¤„ç†é€»è¾‘ã€‚ç”±äºæˆ‘ä»¬å¯èƒ½ä¼šç¼–å†™å¤šä¸ªè½¬æ¢å‡½æ•°ï¼Œæˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªtransformå‡½æ•°æ¥å¤„ç†è¿™äº›è½¬æ¢å‡½æ•°çš„è°ƒç”¨é€»è¾‘ã€‚

`src/core/transoform.ts`:

```typescript
import { AxiosTransformer } from '../types'

export default function transform(
	 data:any,
     headers:any,
     fns?:AxiosTransformer | AxiosTransformer[]
):any{
    if(!fns){
        return data
    }
    if(!Array.isArray(fns)){
        fns=[fns]
    }
    fns.forEach(fn=>{
        data=fn(data,headers)
    })
    return data;
}
```

`transform`å‡½æ•°ä¸­æ¥æ”¶`data`ã€`headers`ã€`fns`ä¸‰ä¸ªå‚æ•°ï¼Œå…¶ä¸­`fns`ä»£è¡¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªè½¬æ¢å‡½æ•°ï¼Œå†…éƒ¨é€»è¾‘å¾ˆç®€å•ï¼Œéå†`fns`ï¼Œæ‰§è¡Œè¿™äº›è½¬æ¢å‡½æ•°ï¼Œå¹¶ä¸”æŠŠ`data`å’Œ`headers`ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œæ¯ä¸ªè½¬æ¢å‡½æ•°è¿”å›`data`ä¼šä½œä¸ºä¸‹ä¸€ä¸ªè½¬æ¢å‡½æ•°çš„å‚æ•°`data`ä¼ å…¥ã€‚

æ¥ä¸‹æ¥ä¿®æ”¹å¯¹è¯·æ±‚æ•°æ®å’Œå“åº”æ•°æ®çš„å¤„ç†é€»è¾‘ã€‚

`src/core/dispatchRequest.ts`:

```typescript
import transform from './transform';

function processConfig(config: AxiosRequestConfig): void {
  config.url = transformURL(config)
  config.data = transform(config.data, config.headers, config.transformRequest)
  config.headers = flattenHeaders(config.headers, config.method!)
}

function transformResponseData(res:AxiosResponse):AxiosResponse{
    res.data = transform(res.data,res.headers,res.config.transformResponse)
  	return res
}
```

æˆ‘ä»¬æŠŠå¯¹è¯·æ±‚æ•°æ®çš„å¤„ç†å’Œå¯¹å“åº”æ•°æ®çš„å¤„ç†æ”¹æˆä½¿ç”¨`transform`å‡½æ•°å®ç°ï¼Œå¹¶æŠŠé…ç½®ä¸­çš„`transformRequest`åŠ`transformResponse`åˆ†åˆ«ä¼ å…¥ã€‚



### demoç¼–å†™

```typescript
axios({
  transformRequest: [
      	(function(data) {
    		return qs.stringify(data)
  		}), 
      	...(axios.defaults.transformRequest as AxiosTransformer[])
  ],
  transformResponse: [
      	...(axios.defaults.transformResponse as AxiosTransformer[]), 
      	function(data) {
    		if (typeof data === 'object') {
      			data.b = 2
    		}
    		return data
  		}
  ],
  url: '/config/post',
  method: 'post',
  data: {
    a: 1
  }
}).then((res) => {
  console.log(res.data)
})
```

æˆ‘ä»¬å¯¹ `transformRequest` åšäº†ä¿®æ”¹ï¼Œåœ¨æ‰§è¡Œå®ƒé»˜è®¤çš„ `transformRequest` ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç”¨ `qs.stringify` åº“å¯¹ä¼ å…¥çš„æ•°æ® `data` åšäº†ä¸€å±‚è½¬æ¢ã€‚åŒæ—¶ä¹Ÿå¯¹ `transformResponse` åšäº†ä¿®æ”¹ï¼Œåœ¨æ‰§è¡Œå®Œé»˜è®¤çš„ `transformResponse` åï¼Œä¼šç»™å“åº”çš„ `data` å¯¹è±¡æ·»åŠ ä¸€ä¸ª `data.b = 2`ã€‚

å› ä¸ºä¹‹å‰æˆ‘ä»¬å®ç°äº†é…ç½®çš„åˆå¹¶ï¼Œè€Œä¸”æˆ‘ä»¬ä¼ å…¥çš„ `transformRequest` å’Œ `transformResponse` éµå¾ªé»˜è®¤åˆå¹¶ç­–ç•¥ï¼Œå®ƒä»¬ä¼šè¦†ç›–é»˜è®¤çš„å€¼ã€‚

è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®ç°äº†è¯·æ±‚å’Œå“åº”çš„é…ç½®åŒ–ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„ axios éƒ½æ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œä¸€æ—¦æˆ‘ä»¬ä¿®æ”¹äº† axios çš„é»˜è®¤é…ç½®ï¼Œä¼šå½±å“æ‰€æœ‰çš„è¯·æ±‚ã€‚å®˜ç½‘æä¾›äº†ä¸€ä¸ª `axios.create` çš„å·¥å‚æ–¹æ³•å…è®¸æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ `axios` å®ä¾‹ï¼ŒåŒæ—¶å…è®¸æˆ‘ä»¬ä¼ å…¥æ–°çš„é…ç½®å’Œé»˜è®¤é…ç½®åˆå¹¶ï¼Œå¹¶åšä¸ºæ–°çš„é»˜è®¤é…ç½®ã€‚ä¸‹é¢ä¸€èŠ‚æˆ‘ä»¬å°±æ¥å®ç°è¿™ä¸ª featureã€‚



## æ‰©å±•axios.createé™æ€æ¥å£

### éœ€æ±‚åˆ†æ

ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„axioséƒ½æ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œä¸€æ—¦æˆ‘ä»¬ä¿®æ”¹äº† axios çš„é»˜è®¤é…ç½®ï¼Œä¼šå½±å“æ‰€æœ‰çš„è¯·æ±‚ã€‚æˆ‘ä»¬å¸Œæœ›æä¾›äº†ä¸€ä¸ª `axios.create` çš„é™æ€æ¥å£å…è®¸æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ `axios` å®ä¾‹ï¼ŒåŒæ—¶å…è®¸æˆ‘ä»¬ä¼ å…¥æ–°çš„é…ç½®å’Œé»˜è®¤é…ç½®åˆå¹¶ï¼Œå¹¶åšä¸ºæ–°çš„é»˜è®¤é…ç½®ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

```typescript
const instance = axios.create({
  transformRequest: [
      (function(data) {
          return qs.stringify(data)
      }),
      ...(axios.defaults.transformRequest as AxiosTransformer[])
  ],
  transformResponse: [
      ...(axios.defaults.transformResponse as AxiosTransformer[]), 
      function(data) {
    	if (typeof data === 'object') {
      		data.b = 2
    	}
    	return data
  	}
  ]
})

instance({
  url: '/config/post',
  method: 'post',
  data: {
    a: 1
  }
})
```

### é™æ€æ–¹æ³•æ‰©å±•

ç”±äº `axios` æ‰©å±•äº†ä¸€ä¸ªé™æ€æ¥å£ï¼Œå› æ­¤æˆ‘ä»¬å…ˆæ¥ä¿®æ”¹æ¥å£ç±»å‹å®šä¹‰ã€‚

`src/types/index.ts`:

```typescript
export interface AxiosStatic extends AxiosInstance{
    create(config?:AxiosRequestConfig):AxiosInstance
}
```

`create`å‡½æ•°å¯ä»¥æ¥å—ä¸€ä¸ª`AxiosRequestConfig`ç±»å‹çš„é…ç½®ä½œä¸ºé»˜è®¤é…ç½®çš„æ‰©å±•ï¼Œä¹Ÿå¯ä»¥æ¥å—ä¸ä¼ å‚æ•°ã€‚

æ¥ç€æˆ‘ä»¬æ¥å®ç°`axios.create`é™æ€æ–¹æ³•ã€‚

`src/axios.ts`:

```typescript
import {AxiosInstance,AxiosRequestConfig,AxiosStatic} form '../types'
import Axios from './core/Axios';
import { extend } from './helpers/util';
import defaults from './defaults'
import mergeConfig from './core/mergeConfig';

// ä¼ å…¥é»˜è®¤çš„defaultsé…ç½®
function createInstance(config:AxiosRequestConfig):AxiosStatic{
    const context = new Axios(config);
 
    const instance = Axios.prototype.request.bind(context);

    extend(instance,context);

    return instance as AxiosStatic
}
// ä¼ å…¥é»˜è®¤çš„defaultsé…ç½®
const axios = createInstance(defaults);

axios.create = function create(config){
    return createInstance(mergeConfig(defaults,config))
}

export default axios;
```

å†…éƒ¨è°ƒç”¨äº† `createInstance` å‡½æ•°ï¼Œå¹¶ä¸”æŠŠå‚æ•° `config` ä¸ `defaults` åˆå¹¶ï¼Œä½œä¸ºæ–°çš„é»˜è®¤é…ç½®ã€‚æ³¨æ„è¿™é‡Œæˆ‘ä»¬éœ€è¦ `createInstance` å‡½æ•°çš„è¿”å›å€¼ç±»å‹ä¸º `AxiosStatic`ã€‚

### demoç¼–å†™

```typescript
const instance = axios.create({
  transformRequest: [(function(data) {
    return qs.stringify(data)
  }), ...(axios.defaults.transformRequest as AxiosTransformer[])],
  transformResponse: [...(axios.defaults.transformResponse as AxiosTransformer[]), function(data) {
    if (typeof data === 'object') {
      data.b = 2
    }
    return data
  }]
})

instance({
  url: '/config/post',
  method: 'post',
  data: {
    a: 1
  }
}).then((res) => {
  console.log(res.data)
})
```

æˆ‘ä»¬å¯¹ä¸ŠèŠ‚çš„ç¤ºä¾‹åšäº†å°å°çš„ä¿®æ”¹ï¼Œé€šè¿‡ `axios.create` æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ `instance`ï¼Œå¹¶ä¼ å…¥äº† `transformRequest` å’Œ `transformResponse` çš„é…ç½®ä¿®æ”¹äº†é»˜è®¤é…ç½®ï¼Œç„¶åé€šè¿‡ `instance` å‘é€è¯·æ±‚ï¼Œæ•ˆæœå’Œä¹‹å‰æ˜¯ä¸€æ ·çš„ã€‚

è‡³æ­¤æˆ‘ä»¬å®ç°äº† `axios.create` é™æ€æ¥å£çš„æ‰©å±•ï¼Œæ•´ä¸ª `ts-axios` çš„é…ç½®åŒ–ä¹Ÿå‘Šä¸€æ®µè½ã€‚å®˜æ–¹ axios åº“è¿˜æ”¯æŒäº†å¯¹è¯·æ±‚å–æ¶ˆçš„èƒ½åŠ›ï¼Œåœ¨å‘é€è¯·æ±‚å‰ä»¥åŠè¯·æ±‚å‘é€å‡ºå»æœªå“åº”å‰éƒ½å¯ä»¥å–æ¶ˆè¯¥è¯·æ±‚ã€‚ä¸‹ä¸€ç« æˆ‘ä»¬å°±æ¥å®ç°è¿™ä¸ª featureã€‚